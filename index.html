<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ascenda - Prototipe Aplikasi</title>
    
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Swiper.js for Swipe Navigation -->
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* CSS MANUAL UNTUK APLIKASI ASCENDA */

        /* 1. Reset & Variabel Global */
        :root {
            --primary: #7B2CBF;
            --primary-light: #A453ED;
            --primary-dark: #4A1A73;
            --accent: #BEF264;
            --accent-dark: #88B42E;
            --bg-light: #F3F4F6;
            --bg-dark: #111827;
            --card-light: #FFFFFF;
            --card-dark: #1F2937;
            --text-light-primary: #1F2937;
            --text-dark-primary: #F9FAFB;
            --text-light-secondary: #6B7280;
            --text-dark-secondary: #9CA3AF;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --priority-high: #FCA5A5; /* red-300 */
            --priority-medium: #FDE68A; /* amber-200 */
            --priority-low: #BFDBFE; /* blue-200 */
            --danger: #ef4444;
            --danger-hover: #dc2626;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            background-color: var(--bg-light);
            color: var(--text-light-primary);
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }

        /* Dark Mode */
        body.dark {
            background-color: var(--bg-dark);
            color: var(--text-dark-primary);
        }

        /* 2. Struktur Utama & Frame Ponsel */
        .phone-frame {
            width: 100%;
            max-width: 400px;
            height: 820px;
            background-color: var(--card-light);
            border-radius: 2.5rem;
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            overflow: hidden;
            border: 4px solid #E5E7EB;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        body.dark .phone-frame {
            background-color: var(--bg-dark);
            border-color: #374151;
        }
        
        .status-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
            padding: 1rem 1.5rem 0 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .status-bar .icons {
            display: flex;
            gap: 0.25rem;
        }

        main.swiper-container {
            flex-grow: 1;
            min-height: 0;
        }
        .swiper-wrapper {
            height: 100%;
        }
        .swiper-slide {
            height: auto;
            overflow-y: auto;
        }
        
        /* Custom Scrollbar */
        .ascenda-scrollbar::-webkit-scrollbar { width: 5px; }
        .ascenda-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .ascenda-scrollbar::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }

        /* 3. Header & Navigasi */
        .page-header {
            margin: 3rem 1.5rem 2rem 1.5rem;
        }
        .page-header h1 {
            font-size: 2.25rem;
            font-weight: 700;
            margin: 0;
        }
        .page-title-primary { color: var(--primary); }
        .page-header p {
            color: var(--text-light-secondary);
            margin: 0.25rem 0 0 0;
        }
        body.dark .page-header p { color: var(--text-dark-secondary); }

        footer {
            flex-shrink: 0;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-top: 1px solid #E5E7EB;
            position: relative;
            z-index: 10;
        }
        body.dark footer {
            background-color: rgba(31, 41, 55, 0.7);
            border-top-color: #374151;
        }
        nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 5rem;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            color: var(--text-light-secondary);
            text-decoration: none;
            cursor: pointer;
        }
        .nav-item span {
            font-size: 0.75rem;
            font-weight: 500;
        }
        .nav-item.active {
            color: var(--primary);
        }
        .nav-item.active span {
            font-weight: 600;
        }

        /* 4. Komponen & Kartu */
        .card {
            background-color: var(--card-light);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
            transition: background-color 0.3s;
            position: relative;
        }
        body.dark .card { background-color: var(--card-dark); }
        
        .button {
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .button:hover { transform: scale(1.05); }
        .button-primary { background-color: var(--primary); color: white; }
        .button-accent { background-color: var(--accent); color: var(--primary-dark); }
        .button-secondary {
            background-color: transparent;
            border: 1px solid #d1d5db;
            color: var(--text-light-primary);
        }
        body.dark .button-secondary {
            border-color: #4b5563;
            color: var(--text-dark-primary);
        }
        .button-danger {
             background-color: var(--danger);
             color: white;
        }
        
        /* 5. Halaman Spesifik */
        /* Auth Screens Container */
        .auth-screen {
            padding: 2rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
            box-sizing: border-box;
        }
        .login-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }
        .login-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0;
        }
        .login-header p {
            margin-top: 0.5rem;
            color: var(--text-light-secondary);
        }
        body.dark .login-header p { color: var(--text-dark-secondary); }

        .input-group {
            margin-bottom: 1.5rem;
        }
        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #D1D5DB;
            background-color: var(--bg-light);
            font-family: 'Poppins', sans-serif;
            box-sizing: border-box;
            color: var(--text-light-primary);
        }
        body.dark .input-field {
            background-color: var(--card-dark);
            border-color: #4B5563;
            color: var(--text-dark-primary);
        }
        .auth-button {
            width: 100%;
            padding: 1rem;
            font-size: 1rem;
        }
        .auth-footer {
            text-align: center;
            margin-top: 1.5rem;
            font-size: 0.875rem;
        }
        .auth-footer a {
            color: var(--primary-light);
            text-decoration: none;
            font-weight: 500;
        }

        .password-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        .password-wrapper .input-field {
            padding-right: 3rem; /* Make space for the icon */
        }
        .password-wrapper i {
            position: absolute;
            right: 1rem;
            cursor: pointer;
            color: var(--text-light-secondary);
        }
        body.dark .password-wrapper i {
            color: var(--text-dark-secondary);
        }


        /* Beranda */
        .home-header {
            background-color: var(--primary);
            color: white;
            padding: 3.5rem 1.5rem 2rem 1.5rem;
            border-bottom-left-radius: 2.5rem;
            border-bottom-right-radius: 2.5rem;
            margin-bottom: 2rem;
        }
        .home-header h1 { font-size: 2rem; margin: 0; font-weight: 700; }
        .home-header p { opacity: 0.8; margin: 0.25rem 0 0 0; }
        .schedule-card {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            border-radius: 1rem;
            padding: 1rem;
            margin-top: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .progress-bar-container {
            width: 100%;
            height: 8px;
            background-color: #E5E7EB;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        body.dark .progress-bar-container { background-color: var(--primary-dark); }

        .progress-bar {
            height: 100%;
            background-color: var(--accent);
            border-radius: 4px;
            transition: width 0.5s ease-in-out;
        }
        #notepad-textarea {
            width: 100%;
            height: 100px;
            border: none;
            background-color: transparent;
            font-family: 'Poppins', sans-serif;
            color: inherit;
            resize: none;
        }

        /* Pomodoro Timer */
        #pomodoro-timer { text-align: center; }
        #pomodoro-time { font-size: 3rem; font-weight: 700; letter-spacing: 0.1em; color: var(--primary); margin: 0.5rem 0 1rem 0; }
        #pomodoro-controls button { margin: 0 0.5rem; background: transparent; border: 1px solid var(--primary); color: var(--primary); }

        /* Jadwal */
        .day-selector {
            display: flex;
            overflow-x: auto;
            gap: 0.5rem;
            padding: 0 1.5rem 1rem;
            scrollbar-width: none; /* Firefox */
        }
        .day-selector::-webkit-scrollbar { display: none; } /* Chrome, Safari, Opera */
        .day-button {
            padding: 0.5rem 1rem;
            border: 1px solid #D1D5DB;
            background-color: var(--card-light);
            border-radius: 999px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            flex-shrink: 0; /* Mencegah tombol mengecil */
        }
        body.dark .day-button { background-color: var(--card-dark); border-color: #4B5563; }
        .day-button.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .schedule-list .item {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .schedule-list .time {
            font-weight: 600;
            color: var(--primary);
            text-align: center;
            min-width: 50px;
        }
        .schedule-list .details { flex-grow: 1; }
        .schedule-list .details p { margin: 0; }
        .schedule-list .title { font-weight: 600; }
        .schedule-list .location { font-size: 0.875rem; color: var(--text-light-secondary); }
        body.dark .schedule-list .location { color: var(--text-dark-secondary); }
        #schedule-container p { text-align: center; color: var(--text-light-secondary); }
        body.dark #schedule-container p { color: var(--text-dark-secondary); }
        .delete-schedule-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-light-secondary);
        }
        .delete-schedule-btn:hover { color: var(--danger); }


        /* Komunitas */
        #komunitas-feed { padding: 0 1.5rem; }
        .create-post-card {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
        }
        .create-post-card img { width: 40px; height: 40px; border-radius: 50%; }
        .create-post-card .placeholder {
            flex-grow: 1;
            color: var(--text-light-secondary);
        }
        body.dark .create-post-card .placeholder { color: var(--text-dark-secondary); }

        .post-card {
            padding: 1rem;
        }
        .post-header { display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.75rem; }
        .post-header-info { flex-grow: 1; }
        .post-header img { width: 40px; height: 40px; border-radius: 50%; }
        .post-header .author { font-weight: 600; }
        .post-header .meta { font-size: 0.75rem; color: var(--text-light-secondary); }
        body.dark .post-header .meta { color: var(--text-dark-secondary); }
        .delete-post-btn { background: none; border: none; cursor: pointer; color: var(--text-light-secondary); padding: 0; }
        .delete-post-btn:hover { color: var(--danger); }
        .post-actions { display: flex; align-items: center; gap: 1.5rem; margin-top: 1rem; color: var(--text-light-secondary); }
        body.dark .post-actions { color: var(--text-dark-secondary); }
        .post-actions button { background: none; border: none; display: flex; align-items: center; gap: 0.3rem; cursor: pointer; color: inherit; font-family: 'Poppins', sans-serif; font-size: 0.875rem;}
        .post-actions button:hover { color: var(--primary); }
        .post-actions button.liked { color: #EF4444; }
        .post-actions button.liked:hover { color: #dc2626; }
        
        /* Tugas */
        .task-list-container { padding: 0 1.5rem; }
        .task-item { display: flex; align-items: flex-start; gap: 1rem; padding: 1rem; }
        .task-item.completed .task-details { text-decoration: line-through; opacity: 0.6; }
        .task-checkbox { margin-top: 0.25rem; width: 20px; height: 20px; flex-shrink: 0; accent-color: var(--primary); }
        .task-details { flex-grow: 1; }
        .task-details p { margin: 0; }
        .task-title { font-weight: 600; }
        .task-course { font-size: 0.875rem; color: var(--text-light-secondary); }
        body.dark .task-course { color: var(--text-dark-secondary); }
        .task-meta { display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem; }
        .task-deadline { font-size: 0.8rem; font-weight: 500; }
        .priority-tag { font-size: 0.75rem; padding: 0.1rem 0.5rem; border-radius: 999px; font-weight: 600; }
        .priority-high { background-color: var(--priority-high); color: #991B1B; } /* red-800 */
        .priority-medium { background-color: var(--priority-medium); color: #92400E; } /* amber-800 */
        .priority-low { background-color: var(--priority-low); color: #1E40AF; } /* blue-800 */
        .delete-task-btn { background: none; border: none; cursor: pointer; color: var(--text-light-secondary); padding: 0;}
        .delete-task-btn:hover { color: var(--danger); }


        /* Olahraga */
        .workout-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
        }
        .workout-card .icon-container {
            padding: 1rem;
            background-color: var(--accent);
            border-radius: 0.75rem;
        }
        .workout-card .details h3 {
            margin: 0 0 0.25rem 0;
            font-weight: 600;
        }
        .workout-card .details p {
            margin: 0;
            font-size: 0.875rem;
            color: var(--text-light-secondary);
        }
        body.dark .workout-card .details p { color: var(--text-dark-secondary); }
        .video-placeholder {
            width: 100%;
            height: 200px;
            background-color: #000;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }


        /* Profil */
        .profile-header { text-align: center; margin-bottom: 2rem; }
        .profile-header img { width: 96px; height: 96px; border-radius: 50%; margin: 0 auto 1rem; border: 4px solid var(--accent); }
        .profile-header h2 { margin: 0; font-size: 1.5rem; }
        .profile-menu .item { display: flex; align-items: center; gap: 1rem; padding: 1rem; border-radius: 0.75rem; cursor: pointer; }
        .profile-menu .item:hover { background-color: var(--bg-light); }
        body.dark .profile-menu .item:hover { background-color: var(--card-dark); }
        .profile-menu .item p { margin: 0; font-weight: 500; flex-grow: 1; }

        .theme-switch-wrapper { position: relative; display: inline-block; width: 50px; height: 28px; }
        .theme-switch-wrapper input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(22px); }


        /* Floating Action Button */
        .fab {
            position: absolute;
            bottom: 6.5rem;
            right: 1.5rem;
            width: 4rem;
            height: 4rem;
            border-radius: 1.25rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.2);
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease, opacity 0.3s ease, background-color 0.3s;
        }

        /* 6. Modal */
        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 30;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.visible {
            display: flex;
            opacity: 1;
        }
        .modal-content {
            background-color: var(--card-light);
            border-radius: 1rem;
            padding: 1.5rem;
            width: 90%;
            max-width: 360px;
            box-shadow: var(--shadow);
            transform: scale(0.95);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            max-height: 90%;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        body.dark .modal-content { background-color: var(--card-dark); }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-shrink: 0;
        }
        .modal-header h2 { margin: 0; font-size: 1.25rem; font-weight: 600; }
        .modal-header .close-button { background: none; border: none; cursor: pointer; color: var(--text-light-secondary); }
        body.dark .modal-header .close-button { color: var(--text-dark-secondary); }

        textarea.modal-input {
            width: 100%;
            height: 120px;
            background-color: var(--bg-light);
            border: 1px solid #E5E7EB;
            border-radius: 0.5rem;
            padding: 0.75rem;
            font-family: 'Poppins', sans-serif;
            resize: none;
            box-sizing: border-box;
            margin-bottom: 1rem;
            color: var(--text-light-primary);
        }
        body.dark textarea.modal-input {
            background-color: var(--bg-dark);
            border-color: #374151;
            color: var(--text-dark-primary);
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            flex-shrink: 0;
            gap: 0.5rem;
        }

        /* Comment Modal Specifics */
        .comment-modal-body {
            overflow-y: auto;
            margin-bottom: 1rem;
            flex-grow: 1;
            min-height: 0;
        }
        .original-post-in-modal {
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        body.dark .original-post-in-modal { border-color: #374151; }
        .comment { display: flex; gap: 0.75rem; margin-bottom: 1rem; }
        .comment img { width: 32px; height: 32px; border-radius: 50%; }
        .comment-content {
            background-color: var(--bg-light);
            padding: 0.5rem 0.75rem;
            border-radius: 0.75rem;
            flex-grow: 1;
        }
        body.dark .comment-content { background-color: var(--bg-dark); }
        .comment-content p { margin: 0; }
        .comment-author { font-weight: 600; font-size: 0.875rem; }
        .comment-text { font-size: 0.875rem; }
        .add-comment-form { display: flex; gap: 0.5rem; }
        .add-comment-form input { flex-grow: 1; }

        /* Utility */
        .hidden {
            display: none !important;
        }

    </style>
</head>

<body>
    <!-- Dihapus: class="dark" agar tema default tergantung simpanan user -->

    <div class="phone-frame">
        <div id="auth-container">
            <!-- Halaman Login -->
            <div id="login-screen" class="auth-screen">
                <div class="login-header">
                    <h1>Ascenda</h1>
                    <p>Masuk untuk melanjutkan</p>
                </div>
                <form id="login-form">
                    <div class="input-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" class="input-field" value="kenny@ascenda.co.id" required>
                    </div>
                    <div class="input-group">
                        <label for="password">Password</label>
                        <div class="password-wrapper">
                            <input type="password" id="password" class="input-field" value="Ailyyy_2606" required>
                            <i id="toggle-password" data-lucide="eye"></i>
                        </div>
                    </div>
                    <button type="submit" class="button button-primary auth-button">Masuk</button>
                    <button type="button" id="anonymous-login-btn" class="button button-secondary auth-button" style="margin-top: 0.5rem;">Masuk sebagai Tamu</button>
                </form>
                <div class="auth-footer">
                    <a href="#" id="go-to-forgot">Lupa Password?</a>
                    <p style="margin-top: 1rem;">Belum punya akun? <a href="#" id="go-to-signup">Daftar</a></p>
                </div>
            </div>

            <!-- Halaman Daftar -->
            <div id="signup-screen" class="auth-screen hidden">
                 <div class="login-header">
                    <h1>Buat Akun</h1>
                    <p>Selamat datang di Ascenda!</p>
                </div>
                <form id="signup-form">
                    <div class="input-group">
                        <label for="signup-name">Nama Panggilan</label>
                        <input type="text" id="signup-name" class="input-field" required>
                    </div>
                    <div class="input-group">
                        <label for="signup-email">Email</label>
                        <input type="email" id="signup-email" class="input-field" required>
                    </div>
                    <div class="input-group">
                        <label for="signup-password">Password</label>
                        <div class="password-wrapper">
                            <input type="password" id="signup-password" class="input-field" minlength="6" required>
                            <i id="toggle-signup-password" data-lucide="eye"></i>
                        </div>
                    </div>
                    <button type="submit" class="button button-primary auth-button">Daftar</button>
                </form>
                <div class="auth-footer">
                    <p>Sudah punya akun? <a href="#" id="go-to-login-from-signup">Masuk</a></p>
                </div>
            </div>

            <!-- Halaman Lupa Password -->
            <div id="forgot-password-screen" class="auth-screen hidden">
                <div class="login-header">
                    <h1>Lupa Password</h1>
                    <p>Masukkan email Anda untuk reset password.</p>
                </div>
                <form id="forgot-password-form">
                    <div class="input-group">
                        <label for="forgot-email">Email</label>
                        <input type="email" id="forgot-email" class="input-field" required>
                    </div>
                    <button type="submit" class="button button-primary auth-button">Kirim Instruksi</button>
                </form>
                <div class="auth-footer">
                     <a href="#" id="go-to-login-from-forgot">Kembali ke Login</a>
                </div>
            </div>
        </div>

        <!-- Kontainer Aplikasi Utama (Awalnya Tersembunyi) -->
        <div id="main-app" class="hidden" style="height:100%; display:flex; flex-direction:column;">
            <div class="status-bar">
                <span>11:23</span>
                <div class="icons">
                    <i data-lucide="bar-chart-2" style="width:16px; height:16px;"></i>
                    <i data-lucide="wifi" style="width:16px; height:16px;"></i>
                    <i data-lucide="battery-full" style="width:16px; height:16px;"></i>
                </div>
            </div>

            <main class="swiper-container">
                <div class="swiper-wrapper">
                    
                    <!-- Slide 1: Beranda -->
                    <div class="swiper-slide ascenda-scrollbar">
                        <div id="beranda" style="padding-bottom: 6rem;">
                            <div class="home-header">
                                <h1 id="greeting-header">Selamat Pagi, Fathur!</h1>
                                <p>Siap untuk hari yang produktif?</p>
                                <div class="schedule-card">
                                    <div>
                                        <p id="next-event-title" style="font-size: 1.125rem; font-weight: 700; margin:0;"></p>
                                        <p id="next-event-location" style="font-size: 0.875rem; opacity: 0.8; margin:0;"></p>
                                    </div>
                                    <div style="text-align: right;">
                                        <p id="next-event-time" style="font-size: 1.125rem; font-weight: 700; margin:0;"></p>
                                        <p id="next-event-countdown" style="font-size: 0.875rem; opacity: 0.8; margin:0;"></p>
                                    </div>
                                </div>
                            </div>
                            <div style="padding: 0 1.5rem;">
                                <!-- Mode Fokus -->
                                <div class="card" id="pomodoro-timer">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <h2 style="font-size: 1.25rem; font-weight: 700; margin:0;">Mode Fokus</h2>
                                        <button id="pomodoro-settings-trigger" style="background: none; border: none; cursor: pointer; color: var(--text-light-secondary);"><i data-lucide="settings-2"></i></button>
                                    </div>
                                    <p id="pomodoro-time">25:00</p>
                                    <div id="pomodoro-controls" style="display: flex; justify-content: center; gap: 1rem;">
                                        <button id="pomodoro-start-pause" class="button button-primary">Mulai</button>
                                        <button id="pomodoro-reset" class="button">Reset</button>
                                    </div>
                                </div>


                                <!-- Finansial -->
                                <div>
                                    <h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem;">Keuangan</h2>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                        <div class="card" style="margin:0; background-color: var(--primary-dark); color: white;">
                                            <i data-lucide="wallet"></i>
                                            <h3 style="margin:0.5rem 0; font-size:0.875rem; opacity: 0.8;">Sisa Budget</h3>
                                            <p id="current-budget-text" style="margin:0; font-size: 1.25rem; font-weight: 700;">Rp0</p>
                                        </div>
                                        <div id="add-transaction-trigger" class="card" style="margin:0; background-color: var(--accent); color: var(--primary-dark); cursor: pointer;">
                                            <i data-lucide="plus-circle"></i>
                                            <h3 style="margin:0.5rem 0; font-size:0.875rem;">Tambah</h3>
                                            <p style="margin:0; font-size: 1.25rem; font-weight: 700;">Transaksi</p>
                                        </div>
                                    </div>
                                     <button id="financial-report-trigger" class="button button-primary" style="width: 100%; margin-bottom: 1rem;">Lihat Laporan Keuangan</button>
                                </div>


                                <!-- Target & Pertumbuhan -->
                                <div>
                                    <h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem;">Target & Pertumbuhan</h2>
                                    <div id="savings-card-trigger" class="card" style="cursor: pointer;">
                                        <!-- Content will be rendered by JS -->
                                    </div>
                                </div>

                                <!-- Olahraga -->
                                <div id="olahraga-section">
                                     <h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem;">Tetap Bugar</h2>
                                     <button id="workout-list-trigger" class="button button-primary" style="width: 100%; margin-bottom: 1rem;">Mulai Olahraga</button>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- Slide 2: Jadwal -->
                    <div class="swiper-slide ascenda-scrollbar">
                        <div id="jadwal" style="padding-bottom: 6rem;">
                            <div class="page-header"><h1 class="page-title-primary">Jadwal Mingguan</h1><p>Semua kegiatanmu dalam satu tempat.</p></div>
                            <div class="day-selector">
                                <!-- Akan diisi oleh JS -->
                            </div>
                            <div id="schedule-container" class="schedule-list" style="padding: 0 1.5rem;">
                                <!-- Jadwal akan dirender di sini oleh JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Slide 3: Komunitas -->
                    <div class="swiper-slide ascenda-scrollbar">
                        <div id="komunitas" style="padding-bottom: 6rem;">
                            <div class="page-header"><h1 class="page-title-primary">Komunitas Ascenda</h1><p>Bagikan ceritamu di sini!</p></div>
                            <div id="komunitas-feed">
                                <div class="card create-post-card" id="create-post-trigger">
                                    <img src="https://placehold.co/40x40/7B2CBF/FFFFFF?text=F" id="create-post-avatar">
                                    <span class="placeholder" id="create-post-placeholder">Apa yang kamu pikirkan, Fathur?</span>
                                </div>
                                <!-- Posts will be rendered by JS -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Slide 4: Tugas -->
                    <div class="swiper-slide ascenda-scrollbar">
                        <div id="tugas" style="padding-bottom: 6rem;">
                            <div class="page-header"><h1 class="page-title-primary">Manajemen Tugas</h1><p>Jangan sampai ada yang terlewat.</p></div>
                            <div id="task-list-container" class="task-list-container">
                                <!-- Tugas akan dirender di sini -->
                            </div>
                        </div>
                    </div>


                    <!-- Slide 5: Profil -->
                    <div class="swiper-slide ascenda-scrollbar">
                        <div id="profil" style="padding-bottom: 6rem;">
                            <div class="page-header" style="text-align: center;">
                                <img src="https://placehold.co/100x100/7B2CBF/FFFFFF?text=F" id="profile-avatar" style="width: 96px; height: 96px; border-radius: 50%; margin: 0 auto 1rem; border: 4px solid var(--accent);">
                                <h1 id="profile-name" style="font-size:1.5rem;">Fathur Rahman</h1><p id="profile-email">fathur@ascenda.app</p>
                            </div>
                            <div class="profile-menu" style="padding: 0 1.5rem;">
                                <div id="edit-greeting-trigger" class="item">
                                    <i data-lucide="user-cog" style="color:var(--primary)"></i>
                                    <p>Atur Panggilan</p>
                                </div>
                                <div id="set-budget-trigger" class="item">
                                    <i data-lucide="coins" style="color:var(--primary)"></i>
                                    <p>Atur Budget Bulanan</p>
                                </div>
                                 <div id="edit-savings-trigger" class="item">
                                    <i data-lucide="piggy-bank" style="color:var(--primary)"></i>
                                    <p>Atur Target Tabungan</p>
                                </div>
                                <div class="item">
                                    <i data-lucide="bell" style="color:var(--primary)"></i>
                                    <p>Notifikasi</p>
                                </div>
                                <div class="item">
                                    <i data-lucide="sun" id="theme-icon" style="color:var(--primary)"></i>
                                    <p>Mode Tampilan</p>
                                    <div class="theme-switch-wrapper">
                                        <label class="theme-switch">
                                            <input type="checkbox" id="theme-checkbox">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                                <div id="logout-button" class="item">
                                    <i data-lucide="log-out" style="color:#EF4444"></i>
                                    <p>Keluar</p>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </main>

            <button class="fab button button-accent" id="fab-button">
                <i data-lucide="plus" style="width: 32px; height: 32px;"></i>
            </button>

            <footer>
                <nav>
                    <a class="nav-item active" data-index="0"><i data-lucide="layout-grid"></i><span>Beranda</span></a>
                    <a class="nav-item" data-index="1"><i data-lucide="calendar"></i><span>Jadwal</span></a>
                    <a class="nav-item" data-index="2"><i data-lucide="users-2"></i><span>Komunitas</span></a>
                    <a class="nav-item" data-index="3"><i data-lucide="clipboard-list"></i><span>Tugas</span></a>
                    <a class="nav-item" data-index="4"><i data-lucide="user-2"></i><span>Profil</span></a>
                </nav>
            </footer>
        </div>
    </div>
    
    <!-- MODAL AREA -->
    <div id="alert-modal" class="modal-overlay">
        <div class="modal-content" style="text-align: center;">
            <div id="alert-icon" style="font-size: 3rem; margin-bottom: 1rem;"></div>
            <h2 id="alert-title" style="margin-top:0;"></h2>
            <p id="alert-message"></p>
            <div class="modal-actions" style="justify-content: center; margin-top: 1rem;">
                <button class="button button-primary close-button" data-target-modal="alert-modal">OK</button>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="confirmation-title">Konfirmasi</h2>
                <button class="close-button" data-target-modal="confirmation-modal"><i data-lucide="x"></i></button>
            </div>
            <p id="confirmation-message" style="margin-top: 0; margin-bottom: 1.5rem;">Apakah Anda yakin ingin melanjutkan?</p>
            <div class="modal-actions">
                <button id="confirmation-cancel-btn" class="button button-secondary">Batal</button>
                <button id="confirmation-confirm-btn" class="button button-danger">Hapus</button>
            </div>
        </div>
    </div>

    <div id="add-task-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Tambah Tugas Baru</h2>
                <button class="close-button" data-target-modal="add-task-modal"><i data-lucide="x"></i></button>
            </div>
            <form id="add-task-form">
                <div class="input-group">
                    <label for="task-title">Nama Tugas</label>
                    <input type="text" id="task-title" class="input-field" required>
                </div>
                 <div class="input-group">
                    <label for="task-course">Mata Kuliah</label>
                    <input type="text" id="task-course" class="input-field">
                </div>
                <div class="input-group">
                    <label for="task-deadline">Tenggat Waktu</label>
                    <input type="date" id="task-deadline" class="input-field" required>
                </div>
                <div class="input-group">
                    <label for="task-priority">Prioritas</label>
                    <select id="task-priority" class="input-field">
                        <option value="medium">Sedang</option>
                        <option value="high">Tinggi</option>
                        <option value="low">Rendah</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="button button-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>


    <div id="create-post-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Buat Postingan Baru</h2>
                <button class="close-button" data-target-modal="create-post-modal"><i data-lucide="x"></i></button>
            </div>
            <textarea id="post-input" class="modal-input" placeholder="Apa yang kamu pikirkan?"></textarea>
            <div class="modal-actions">
                <button id="submit-post-button" class="button button-primary">Kirim</button>
            </div>
        </div>
    </div>

    <div id="add-schedule-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Tambah Jadwal Baru</h2>
                <button class="close-button" data-target-modal="add-schedule-modal"><i data-lucide="x"></i></button>
            </div>
            <form id="add-schedule-form">
                <div class="input-group">
                    <label for="schedule-title">Nama Kegiatan</label>
                    <input type="text" id="schedule-title" class="input-field" required>
                </div>
                 <div class="input-group">
                    <label for="schedule-location">Lokasi</label>
                    <input type="text" id="schedule-location" class="input-field">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="input-group">
                        <label for="schedule-start-time">Mulai</label>
                        <input type="time" id="schedule-start-time" class="input-field" required>
                    </div>
                    <div class="input-group">
                        <label for="schedule-end-time">Selesai</label>
                        <input type="time" id="schedule-end-time" class="input-field" required>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="button button-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-greeting-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Atur Panggilan</h2>
                <button class="close-button" data-target-modal="edit-greeting-modal"><i data-lucide="x"></i></button>
            </div>
            <form id="edit-greeting-form">
                <div class="input-group">
                    <label for="greeting-name-input">Nama Panggilan</label>
                    <input type="text" id="greeting-name-input" class="input-field" required>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="button button-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-savings-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Atur Target Tabungan</h2>
                <button class="close-button" data-target-modal="edit-savings-modal"><i data-lucide="x"></i></button>
            </div>
            <form id="edit-savings-form">
                <div class="input-group">
                    <label for="savings-target-name">Nama Target</label>
                    <input type="text" id="savings-target-name" class="input-field" required>
                </div>
                <div class="input-group">
                    <label for="savings-target-amount">Jumlah Target (Rp)</label>
                    <input type="number" id="savings-target-amount" class="input-field" required>
                </div>
                <div class="modal-actions" style="justify-content: space-between;">
                    <button type="button" id="reset-savings-button" class="button button-secondary">Reset Progress</button>
                    <div class="right-actions">
                       <button type="submit" class="button button-primary">Simpan</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="workout-list-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Pilih Olahraga</h2>
                <button class="close-button" data-target-modal="workout-list-modal"><i data-lucide="x"></i></button>
            </div>
            <div id="workout-list-content" class="ascenda-scrollbar" style="overflow-y: auto;">
                 <div class="card workout-card" data-title="Jalan Cepat 15 Menit">
                    <div class="icon-container"><i data-lucide="heart-pulse" style="color: var(--primary-dark);"></i></div>
                    <div class="details"><h3>Jalan Cepat 15 Menit</h3><p>Segarkan pikiran di sekitar kampus.</p></div>
                </div>
                <div class="card workout-card" data-title="Latihan Pernapasan">
                    <div class="icon-container"><i data-lucide="wind" style="color: var(--primary-dark);"></i></div>
                    <div class="details"><h3>Latihan Pernapasan</h3><p>Kurangi stres sebelum ujian.</p></div>
                </div>
                 <div class="card workout-card" data-title="Push-up & Sit-up">
                    <div class="icon-container"><i data-lucide="weight-lifter" style="color: var(--primary-dark);"></i></div>
                    <div class="details"><h3>Push-up & Sit-up</h3><p>Bangun kekuatan inti di sela waktu.</p></div>
                </div>
            </div>
        </div>
    </div>

     <div id="workout-video-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="workout-title"></h2>
                <button class="close-button" data-target-modal="workout-video-modal"><i data-lucide="x"></i></button>
            </div>
            <div class="video-placeholder">
                <i data-lucide="play-circle" style="width: 48px; height: 48px;"></i>
            </div>
        </div>
    </div>
    
    <div id="add-transaction-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Tambah Transaksi</h2>
                <button class="close-button" data-target-modal="add-transaction-modal"><i data-lucide="x"></i></button>
            </div>
            <form id="add-transaction-form">
                <div class="input-group">
                    <label for="transaction-amount">Jumlah (Rp)</label>
                    <input type="number" id="transaction-amount" class="input-field" placeholder="Contoh: 15000" required>
                </div>
                 <div class="input-group">
                    <label for="transaction-category">Kategori</label>
                    <select id="transaction-category" class="input-field">
                        <option value="Makanan">Makanan</option>
                        <option value="Transportasi">Transportasi</option>
                        <option value="Kebutuhan Kuliah">Kebutuhan Kuliah</option>
                        <option value="Hiburan">Hiburan</option>
                        <option value="Lainnya">Lainnya</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="button button-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="set-budget-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Atur Budget Bulanan</h2>
                <button class="close-button" data-target-modal="set-budget-modal"><i data-lucide="x"></i></button>
            </div>
            <form id="set-budget-form">
                <div class="input-group">
                    <label for="budget-amount">Budget Bulanan (Rp)</label>
                    <input type="number" id="budget-amount" class="input-field" placeholder="Contoh: 1500000" required>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="button button-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-savings-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Tambah Tabungan</h2>
                <button class="close-button" data-target-modal="add-savings-modal"><i data-lucide="x"></i></button>
            </div>
            <form id="add-savings-form">
                <div class="input-group">
                    <label for="savings-amount">Jumlah (Rp)</label>
                    <input type="number" id="savings-amount" class="input-field" placeholder="Contoh: 50000" required>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="button button-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="financial-report-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Laporan Keuangan</h2>
                <button class="close-button" data-target-modal="financial-report-modal"><i data-lucide="x"></i></button>
            </div>
            <div id="financial-report-content" class="ascenda-scrollbar" style="overflow-y: auto;">
                <!-- Laporan akan dirender di sini -->
            </div>
        </div>
    </div>


    <div id="view-comments-modal" class="modal-overlay">
         <div class="modal-content">
             <div class="modal-header">
                 <h2>Komentar</h2>
                 <button class="close-button" data-target-modal="view-comments-modal"><i data-lucide="x"></i></button>
             </div>
             <div class="comment-modal-body ascenda-scrollbar">
                 <div id="original-post-in-modal"></div>
                 <div id="comments-list"></div>
             </div>
             <form id="add-comment-form" class="add-comment-form">
                 <input type="text" id="comment-input" class="input-field" placeholder="Tulis komentar..." required>
                 <button type="submit" class="button button-primary"><i data-lucide="send"></i></button>
             </form>
         </div>
     </div>

    <div id="pomodoro-settings-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Atur Waktu Fokus</h2>
                <button class="close-button" data-target-modal="pomodoro-settings-modal"><i data-lucide="x"></i></button>
            </div>
            <form id="pomodoro-settings-form">
                <div class="input-group">
                    <label for="pomodoro-duration">Durasi (menit)</label>
                    <input type="number" id="pomodoro-duration" class="input-field" min="1" max="120" required>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="button button-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="timer-finished-modal" class="modal-overlay">
        <div class="modal-content" style="text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
            <h2>Waktu Selesai!</h2>
            <p>Sesi fokusmu telah berakhir. Saatnya istirahat sejenak.</p>
            <div class="modal-actions" style="justify-content: center; margin-top: 1rem;">
                <button class="button button-primary close-button" data-target-modal="timer-finished-modal">OK</button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- Firebase SDK ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithCustomToken, 
            signInAnonymously,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            sendPasswordResetEmail,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, setDoc, getDoc, updateDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variabel Global ---
        let db, auth, userId, commentsUnsubscribe;
        let userProfile = {};
        let allTransactions = [];
        let allTasks = [];
        let schedules = {};
        let activePostIdForComment = null;
        let confirmationCallback = null;
        let allUnsubscribers = [];

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            const body = document.body;
            const authContainer = document.getElementById('auth-container');
            const mainApp = document.getElementById('main-app');
            const fabButton = document.getElementById('fab-button');
            const logoutButton = document.getElementById('logout-button');
            const themeCheckbox = document.getElementById('theme-checkbox');
            const themeIcon = document.getElementById('theme-icon');
            const authScreens = document.querySelectorAll('.auth-screen');
            const navItems = document.querySelectorAll('.nav-item');
            const closeButtons = document.querySelectorAll('.close-button');
            const daySelector = document.querySelector('.day-selector');
            const scheduleContainer = document.getElementById('schedule-container');
            const taskListContainer = document.getElementById('task-list-container');
            const feed = document.getElementById('komunitas-feed');
            const loginForm = document.getElementById('login-form');
            const anonymousLoginBtn = document.getElementById('anonymous-login-btn');
            const signupForm = document.getElementById('signup-form');
            const forgotPasswordForm = document.getElementById('forgot-password-form');
            const addTransactionModal = document.getElementById('add-transaction-modal');
            const addTransactionTrigger = document.getElementById('add-transaction-trigger');
            const addTransactionForm = document.getElementById('add-transaction-form');
            const currentBudgetText = document.getElementById('current-budget-text');
            const setBudgetModal = document.getElementById('set-budget-modal');
            const setBudgetTrigger = document.getElementById('set-budget-trigger');
            const setBudgetForm = document.getElementById('set-budget-form');
            const financialReportTrigger = document.getElementById('financial-report-trigger');
            const financialReportModal = document.getElementById('financial-report-modal');
            const savingsCardTrigger = document.getElementById('savings-card-trigger');
            const addSavingsModal = document.getElementById('add-savings-modal');
            const editSavingsModal = document.getElementById('edit-savings-modal');
            const editSavingsTrigger = document.getElementById('edit-savings-trigger');
            const resetSavingsButton = document.getElementById('reset-savings-button');
            const editGreetingModal = document.getElementById('edit-greeting-modal');
            const editGreetingTrigger = document.getElementById('edit-greeting-trigger');
            const editGreetingForm = document.getElementById('edit-greeting-form');
            const addTaskModal = document.getElementById('add-task-modal');
            const addTaskForm = document.getElementById('add-task-form');
            const createPostModal = document.getElementById('create-post-modal');
            const submitPostButton = document.getElementById('submit-post-button');
            const viewCommentsModal = document.getElementById('view-comments-modal');
            const addCommentForm = document.getElementById('add-comment-form');
            const pomodoroSettingsTrigger = document.getElementById('pomodoro-settings-trigger');
            const pomodoroSettingsModal = document.getElementById('pomodoro-settings-modal');
            const pomodoroSettingsForm = document.getElementById('pomodoro-settings-form');
            const timerFinishedModal = document.getElementById('timer-finished-modal');
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmationTitle = document.getElementById('confirmation-title');
            const confirmationMessage = document.getElementById('confirmation-message');
            const confirmationCancelBtn = document.getElementById('confirmation-cancel-btn');
            const confirmationConfirmBtn = document.getElementById('confirmation-confirm-btn');
            const alertModal = document.getElementById('alert-modal');
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            let currentDay = days[new Date().getDay()].toLowerCase();

            // Utility Unsub
            function resetAllUnsubscribers() {
                allUnsubscribers.forEach(f => { try { f(); } catch(e) {} });
                allUnsubscribers = [];
                if(commentsUnsubscribe) { try { commentsUnsubscribe(); } catch(e) {} commentsUnsubscribe = null; }
            }

            function showAlert(title, message, isError = false) {
                document.getElementById('alert-title').textContent = title;
                document.getElementById('alert-message').textContent = message;
                document.getElementById('alert-icon').textContent = isError ? '' : '';
                openModal(alertModal);
            }

            function applyTheme(theme) {
                if (theme === 'dark') {
                    body.classList.add('dark');
                    themeCheckbox.checked = true;
                    themeIcon.setAttribute('data-lucide', 'moon');
                } else {
                    body.classList.remove('dark');
                    themeCheckbox.checked = false;
                    themeIcon.setAttribute('data-lucide', 'sun');
                }
                lucide.createIcons(); 
            }

            function showAuthScreen(screenId) {
                authScreens.forEach(screen => {
                    screen.classList.toggle('hidden', screen.id !== screenId);
                });
                authScreens.forEach(screen => {
                    screen.querySelectorAll('input').forEach(i => i.value = '');
                });
            }

            function openModal(modal) {
                if(modal) {
                    modal.classList.add('visible');
                    modal.querySelectorAll('input, textarea').forEach(i => {
                        if(i.type !== "checkbox") i.value = '';
                    });
                }
            }
            function closeModal(modal) {
                if(modal) modal.classList.remove('visible');
            }

            function showConfirmationModal(title, message, onConfirm) {
                confirmationTitle.textContent = title;
                confirmationMessage.textContent = message;
                confirmationCallback = onConfirm;
                openModal(confirmationModal);
            }
            
            function initializeAppData() {
                initializeProfile();
                initializeSchedule(); 
                initializeTasks();
                initializeCommunity();
                initializeTransactions();
                initializePomodoro();
                setInterval(updateHomepageSchedule, 30000); 
                setInterval(() => {
                    document.querySelector('.status-bar span').textContent = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                }, 1000);
            }

            function formatCurrency(amount) {
                 if (typeof amount !== 'number') return 'Rp 0';
                return `Rp ${amount.toLocaleString('id-ID')}`;
            }

            async function initializeProfile() {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'ascenda-app-test';
                const profileDocPath = `/artifacts/${appId}/users/${userId}/profile/settings`;
                const docRef = doc(db, profileDocPath);

                const unsub = onSnapshot(docRef, (doc) => {
                    if (doc.exists()) {
                        userProfile = doc.data();
                        updateAllGreetings();
                        updateBudgetUI();
                        updateSavingsUI();
                        resetPomodoroTimer();
                    }
                });
                allUnsubscribers.push(unsub);
            }

            function initializeTransactions() {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'ascenda-app-test';
                const transactionsPath = `/artifacts/${appId}/users/${userId}/transactions`;
                const q = query(collection(db, transactionsPath));

                const unsub = onSnapshot(q, (snapshot) => {
                    allTransactions = [];
                    snapshot.forEach(doc => allTransactions.push({ id: doc.id, ...doc.data() }));
                    updateBudgetUI();
                });
                allUnsubscribers.push(unsub);
            }

            function updateBudgetUI() {
                const totalSpent = allTransactions.reduce((sum, tx) => sum + tx.amount, 0);
                const remainingBudget = (userProfile.totalBudget || 0) - totalSpent;
                currentBudgetText.textContent = formatCurrency(remainingBudget);
            }

            function updateSavingsUI() {
                const { currentSavings = 0, targetSavings = 0, savingsTargetName = "Target Tabungan" } = userProfile || {};
                if(!savingsCardTrigger) return;
                const percentage = (targetSavings > 0) ? (currentSavings / targetSavings) * 100 : 0;
                if (targetSavings > 0 && currentSavings >= targetSavings) {
                    savingsCardTrigger.innerHTML = `
                        <div style="text-align:center; padding: 1rem;">
                            <h3 style="font-size: 1.25rem; color: var(--accent-dark); margin: 0;"> Target Tercapai! </h3>
                            <p style="margin: 0.5rem 0 1rem 0;">Selamat, kamu berhasil mencapai target <strong>${savingsTargetName}</strong>!</p>
                            <button id="start-new-target-button" class="button button-accent">Mulai Target Baru</button>
                        </div>
                    `;
                    document.getElementById('start-new-target-button').onclick = () => openModal(editSavingsModal);
                } else {
                     savingsCardTrigger.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="padding: 0.75rem; background-color: var(--accent); border-radius: 0.5rem;"><i data-lucide="piggy-bank" style="color: var(--primary-dark);"></i></div>
                            <div style="flex-grow: 1;">
                                <p style="font-weight: 600; margin:0;">${savingsTargetName || 'Target Tabungan'}</p>
                                <p style="font-size: 0.875rem; color: var(--text-light-secondary); margin:0;">
                                    ${formatCurrency(currentSavings)} / ${formatCurrency(targetSavings)}
                                </p>
                                <div class="progress-bar-container"><div class="progress-bar" style="width: ${Math.min(percentage, 100)}%;"></div></div>
                            </div>
                        </div>
                    `;
                    lucide.createIcons();
                }
            }

            function updateAllGreetings() {
                const greetingName = userProfile.greetingName || "Pengguna";
                const userEmail = auth.currentUser?.email || "Tamu";
                const currentHour = new Date().getHours();
                let timeOfDayGreeting = "Halo";
                 if (currentHour >= 4 && currentHour < 11) { timeOfDayGreeting = "Selamat Pagi"; } 
                 else if (currentHour >= 11 && currentHour < 15) { timeOfDayGreeting = "Selamat Siang"; } 
                 else if (currentHour >= 15 && currentHour < 19) { timeOfDayGreeting = "Selamat Sore"; } 
                 else { timeOfDayGreeting = "Selamat Malam"; }
                const initial = greetingName.charAt(0).toUpperCase();
                document.getElementById('greeting-header').textContent = `${timeOfDayGreeting}, ${greetingName}!`;
                document.getElementById('create-post-placeholder').textContent = `Apa yang kamu pikirkan, ${greetingName}?`;
                document.getElementById('profile-name').textContent = greetingName;
                document.getElementById('profile-email').textContent = userEmail;
                document.getElementById('profile-avatar').src = `https://placehold.co/100x100/7B2CBF/FFFFFF?text=${initial}`;
                document.getElementById('create-post-avatar').src = `https://placehold.co/40x40/7B2CBF/FFFFFF?text=${initial}`;
            }
            
            async function initializeTasks() {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'ascenda-app-test';
                const tasksPath = `/artifacts/${appId}/users/${userId}/tasks`;
                const q = query(collection(db, tasksPath));

                const unsub = onSnapshot(q, (snapshot) => {
                    allTasks = [];
                    snapshot.forEach(doc => allTasks.push({ id: doc.id, ...doc.data() }));
                    renderTasks();
                });
                allUnsubscribers.push(unsub);
            }

            function renderTasks() {
                taskListContainer.innerHTML = '';
                if(allTasks.length === 0){
                    taskListContainer.innerHTML = `<div class="card" style="text-align:center;"><p>Belum ada tugas. Hebat!</p></div>`;
                    return;
                }
                allTasks.sort((a, b) => {
                    if (a.completed !== b.completed) return a.completed ? 1 : -1;
                    return new Date(a.deadline) - new Date(b.deadline);
                });
                allTasks.forEach(task => {
                    const taskEl = document.createElement('div');
                    taskEl.className = `card task-item ${task.completed ? 'completed' : ''}`;
                    const deadline = new Date(task.deadline + 'T23:59:59'); 
                    const isOverdue = !task.completed && deadline < new Date();
                    taskEl.innerHTML = `
                        <input type="checkbox" class="task-checkbox" data-id="${task.id}" ${task.completed ? 'checked' : ''}>
                        <div class="task-details">
                            <p class="task-title">${task.title}</p>
                            <p class="task-course">${task.course}</p>
                            <div class="task-meta">
                               <span class="task-deadline" style="color: ${isOverdue ? 'var(--danger)' : 'inherit'}">
                                   ${deadline.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'short' })}
                               </span>
                                <span class="priority-tag priority-${task.priority}">${task.priority}</span>
                            </div>
                        </div>
                        <button class="delete-task-btn" data-id="${task.id}"><i data-lucide="trash-2"></i></button>
                    `;
                    taskListContainer.appendChild(taskEl);
                });
                lucide.createIcons();
            }

            async function initializeCommunity() {
                 const appId = typeof __app_id !== 'undefined' ? __app_id : 'ascenda-app-test';
                 const postsPath = `/artifacts/${appId}/public/data/posts`;
                 const q = query(collection(db, postsPath));
                 const unsub = onSnapshot(q, (snapshot) => {
                     const postElements = [];
                     snapshot.forEach(doc => {
                         const post = { id: doc.id, ...doc.data() };
                         postElements.push(createPostElement(post));
                     });
                     while (feed.children.length > 1) {
                         feed.removeChild(feed.lastChild);
                     }
                     postElements.sort((a,b) => b.dataset.createdAt - a.dataset.createdAt).forEach(el => feed.appendChild(el));
                     lucide.createIcons();
                 });
                 allUnsubscribers.push(unsub);
            }

            function createPostElement(post) {
                const postEl = document.createElement('div');
                postEl.className = 'card post-card';
                postEl.dataset.postId = post.id;
                postEl.dataset.authorId = post.authorId;
                const postTimestamp = post.createdAt?.toDate ? post.createdAt.toDate() : new Date();
                postEl.dataset.createdAt = postTimestamp.getTime();
                const postDate = postTimestamp.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
                const isLiked = post.likedBy && post.likedBy.includes(userId);
                const deleteButtonHTML = post.authorId === userId ? `<button class="delete-post-btn"><i data-lucide="trash-2" style="width:16px; height:16px;"></i></button>` : '';
                postEl.innerHTML = `
                    <div class="post-header">
                        <img src="https://placehold.co/40x40/A453ED/FFFFFF?text=${post.author.charAt(0).toUpperCase()}">
                        <div class="post-header-info">
                            <p class="author">${post.author}</p>
                            <p class="meta">${postDate}</p>
                        </div>
                        ${deleteButtonHTML}
                    </div>
                    <p>${post.text}</p>
                    <div class="post-actions">
                        <button class="like-button ${isLiked ? 'liked' : ''}"><i data-lucide="heart" ${isLiked ? 'style="fill: currentColor;"' : ''}></i><span>${post.likes || 0}</span></button>
                        <button class="comment-button"><i data-lucide="message-square"></i><span>${post.commentsCount || 0}</span></button>
                        <button class="share-button"><i data-lucide="share-2"></i></button>
                    </div>
                `;
                return postEl;
            }

            // --- [FIX] Mengurutkan hari dari Senin - Minggu ---
            function initializeSchedule() {
                daySelector.innerHTML = '';
                const orderedDays = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Minggu'];
                const todayName = days[new Date().getDay()]; // `days` array asli ['Minggu', 'Senin', ...]
                currentDay = todayName.toLowerCase(); // Tetapkan hari ini sebagai default

                orderedDays.forEach(dayName => {
                    const dayKey = dayName.toLowerCase();
                    const button = document.createElement('button');
                    button.className = 'day-button';
                    button.textContent = dayName;
                    button.dataset.day = dayKey;
                    if (dayName === todayName) {
                        button.classList.add('active');
                    }
                    
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        document.querySelector('.day-button.active')?.classList.remove('active');
                        button.classList.add('active');
                        currentDay = dayKey;
                        renderSchedule(currentDay); // Render ulang jadwal untuk hari yang dipilih
                    });
                    daySelector.appendChild(button);
                });
                
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'ascenda-app-test';
                const schedulesPath = `/artifacts/${appId}/users/${userId}/schedules`;
                const q = query(collection(db, schedulesPath));
                onSnapshot(q, (snapshot) => {
                    schedules = { senin: [], selasa: [], rabu: [], kamis: [], jumat: [], sabtu: [], minggu: [] };
                    snapshot.forEach((doc) => {
                        const schedule = { id: doc.id, ...doc.data() };
                        if (schedules[schedule.day]) {
                            schedules[schedule.day].push(schedule);
                        }
                    });
                    renderSchedule(currentDay);
                    updateHomepageSchedule();
                });
            }
            
            function renderSchedule(day) {
                scheduleContainer.innerHTML = '';
                const daySchedules = schedules[day] || [];
                daySchedules.sort((a, b) => a.startTime.localeCompare(b.startTime));

                if (daySchedules.length === 0) {
                    scheduleContainer.innerHTML = `<p style="padding: 2rem 0;">Tidak ada jadwal untuk hari ini.</p>`;
                    return;
                }

                daySchedules.forEach(item => {
                    const scheduleEl = document.createElement('div');
                    scheduleEl.className = 'item card';
                    scheduleEl.innerHTML = `
                        <div class="time">${item.startTime}<br>${item.endTime}</div>
                        <div class="details">
                            <p class="title">${item.title}</p>
                            <p class="location">${item.location}</p>
                        </div>
                        <button class="delete-schedule-btn" data-id="${item.id}"><i data-lucide="trash-2" style="width:16px; height:16px;"></i></button>
                    `;
                    scheduleContainer.appendChild(scheduleEl);
                });
                lucide.createIcons();
            }
            
            function updateHomepageSchedule() {
                const now = new Date();
                const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                const currentDayKey = days[now.getDay()].toLowerCase();
                const todaySchedules = schedules[currentDayKey] || [];
                const titleEl = document.getElementById('next-event-title');
                const locationEl = document.getElementById('next-event-location');
                const timeEl = document.getElementById('next-event-time');
                const countdownEl = document.getElementById('next-event-countdown');

                const ongoingEvent = todaySchedules.find(event => event.startTime <= currentTime && event.endTime > currentTime);
                if (ongoingEvent) {
                    titleEl.textContent = ongoingEvent.title;
                    locationEl.textContent = ongoingEvent.location;
                    timeEl.textContent = `${ongoingEvent.startTime} - ${ongoingEvent.endTime}`;
                    countdownEl.textContent = "Sedang Berlangsung";
                    return;
                }

                const upcomingEvents = todaySchedules
                    .filter(event => event.startTime > currentTime)
                    .sort((a, b) => a.startTime.localeCompare(b.startTime));

                if (upcomingEvents.length > 0) {
                    const nextEvent = upcomingEvents[0];
                    const [eventHours, eventMinutes] = nextEvent.startTime.split(':');
                    const eventDate = new Date();
                    eventDate.setHours(eventHours, eventMinutes, 0, 0);
                    
                    let diffMinutes = Math.round((eventDate - now) / 60000);
                    let countdownText = '';
                    if (diffMinutes < 1) {
                         countdownText = 'Mulai sekarang';
                    } else if (diffMinutes < 60) {
                        countdownText = `${diffMinutes} menit lagi`;
                    } else {
                        const diffHours = Math.floor(diffMinutes / 60);
                        const remMinutes = diffMinutes % 60;
                        countdownText = `${diffHours}j ${remMinutes}m lagi`;
                    }
                    
                    titleEl.textContent = nextEvent.title;
                    locationEl.textContent = nextEvent.location;
                    timeEl.textContent = nextEvent.startTime;
                    countdownEl.textContent = countdownText;
                } else {
                    titleEl.textContent = "Tidak ada jadwal lagi";
                    locationEl.textContent = "Nikmati waktumu!";
                    timeEl.textContent = "";
                    countdownEl.textContent = "Selesai untuk hari ini";
                }
            }
            
            let pomodoroTimerInterval;
            let pomodoroTimeLeft;
            let pomodoroIsRunning = false;
            
            function updatePomodoroDisplay() {
                const timeDisplay = document.getElementById('pomodoro-time');
                const minutes = Math.floor(pomodoroTimeLeft / 60);
                const seconds = pomodoroTimeLeft % 60;
                timeDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }

            function resetPomodoroTimer() {
                const startPauseBtn = document.getElementById('pomodoro-start-pause');
                clearInterval(pomodoroTimerInterval);
                pomodoroIsRunning = false;
                startPauseBtn.textContent = 'Mulai';
                pomodoroTimeLeft = (userProfile.pomodoroDuration || 25) * 60;
                updatePomodoroDisplay();
            }
            
            function initializePomodoro() {
                const startPauseBtn = document.getElementById('pomodoro-start-pause');
                const resetBtn = document.getElementById('pomodoro-reset');
                resetPomodoroTimer();

                startPauseBtn.addEventListener('click', () => {
                    if (pomodoroIsRunning) {
                        clearInterval(pomodoroTimerInterval);
                        startPauseBtn.textContent = 'Lanjut';
                    } else {
                        pomodoroTimerInterval = setInterval(() => {
                            pomodoroTimeLeft--;
                            updatePomodoroDisplay();
                            if (pomodoroTimeLeft <= 0) {
                                clearInterval(pomodoroTimerInterval);
                                openModal(timerFinishedModal);
                                resetPomodoroTimer();
                            }
                        }, 1000);
                        startPauseBtn.textContent = 'Jeda';
                    }
                    pomodoroIsRunning = !pomodoroIsRunning;
                });

                resetBtn.addEventListener('click', resetPomodoroTimer);
            }
            
            function renderComments(postId) {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'ascenda-app-test';
                const postRef = doc(db, `/artifacts/${appId}/public/data/posts`, postId);
                const commentsListEl = document.getElementById('comments-list');
                const originalPostContainer = document.getElementById('original-post-in-modal');
                commentsListEl.innerHTML = '<p>Memuat komentar...</p>';
                originalPostContainer.innerHTML = '';
                
                if (commentsUnsubscribe) {
                    commentsUnsubscribe();
                }
                
                const postCardInFeed = document.querySelector(`.post-card[data-post-id="${postId}"]`);
                if (postCardInFeed) {
                    const postClone = postCardInFeed.cloneNode(true);
                    postClone.querySelector('.post-actions')?.remove();
                    originalPostContainer.appendChild(postClone);
                } else {
                     getDoc(postRef).then(docSnap => {
                        if(docSnap.exists()){
                            const post = {id: docSnap.id, ...docSnap.data()};
                            const postEl = createPostElement(post);
                            postEl.querySelector('.post-actions').remove();
                            originalPostContainer.appendChild(postEl);
                        }
                    });
                }

                const commentsPath = `/artifacts/${appId}/public/data/posts/${postId}/comments`;
                const q = query(collection(db, commentsPath));

                commentsUnsubscribe = onSnapshot(q, (snapshot) => {
                    commentsListEl.innerHTML = '';
                    if(snapshot.empty){
                        commentsListEl.innerHTML = '<p>Belum ada komentar.</p>';
                        return;
                    }
                    snapshot.docs.sort((a, b) => a.data().createdAt - b.data().createdAt).forEach(doc => {
                        const comment = doc.data();
                        const commentEl = document.createElement('div');
                        commentEl.className = 'comment';
                        commentEl.innerHTML = `
                            <img src="https://placehold.co/32x32/BEF264/4A1A73?text=${comment.author.charAt(0).toUpperCase()}">
                            <div class="comment-content">
                                <p class="comment-author">${comment.author}</p>
                                <p class="comment-text">${comment.text}</p>
                            </div>
                        `;
                        commentsListEl.appendChild(commentEl);
                    });
                });
            }


            // =================================================================================
            // SECTION: EVENT LISTENERS
            // =================================================================================

            async function main() {
                // Inisialisasi Firebase
                const firebaseConfig = typeof __firebase_config !== 'undefined' 
                    ? JSON.parse(__firebase_config) 
                    : {
                        apiKey: "AIzaSyAKH1P8RLms6iKNlO5HPSG0DhMkmyhU9Bk",
                        authDomain: "ascenda-personalapp.firebaseapp.com",
                        projectId: "ascenda-personalapp",
                        storageBucket: "ascenda-personalapp.appspot.com",
                        messagingSenderId: "860354489561",
                        appId: "1:860354489561:web:7fdfeed865669bf5b822c8",
                        measurementId: "G-WE59Q0KJ39"
                    };
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Listener utama untuk status autentikasi
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("Pengguna masuk:", user.uid);
                        userId = user.uid;
                        authContainer.classList.add('hidden');
                        mainApp.style.display = 'flex'; // Gunakan style untuk kontrol yang lebih baik
                        mainApp.classList.remove('hidden');
                        initializeAppData();
                    } else {
                        console.log("Pengguna keluar.");
                        authContainer.classList.remove('hidden');
                        mainApp.style.display = 'none';
                        mainApp.classList.add('hidden');
                    }
                });

                // Coba login otomatis dengan token jika tersedia
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } catch (error) {
                        console.error("Gagal masuk dengan token, menampilkan halaman login.", error);
                    }
                }
            }
            
            main(); // Jalankan fungsi utama

            themeCheckbox.addEventListener('change', () => {
                const newTheme = themeCheckbox.checked ? 'dark' : 'light';
                localStorage.setItem('ascenda-theme', newTheme);
                applyTheme(newTheme);
            });
            
            document.getElementById('go-to-signup').addEventListener('click', (e) => { e.preventDefault(); showAuthScreen('signup-screen'); });
            document.getElementById('go-to-forgot').addEventListener('click', (e) => { e.preventDefault(); showAuthScreen('forgot-password-screen'); });
            document.getElementById('go-to-login-from-signup').addEventListener('click', (e) => { e.preventDefault(); showAuthScreen('login-screen'); });
            document.getElementById('go-to-login-from-forgot').addEventListener('click', (e) => { e.preventDefault(); showAuthScreen('login-screen'); });


            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Gagal masuk:", error);
                    showAlert('Gagal Masuk', `Terjadi kesalahan: ${error.code}`, true);
                }
            });

            anonymousLoginBtn.addEventListener('click', async () => {
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Gagal masuk anonim:", error);
                    showAlert('Gagal Masuk', `Terjadi kesalahan: ${error.code}`, true);
                }
            });

            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('signup-name').value;
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const newUser = userCredential.user;

                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'ascenda-app-test';
                    const profileDocPath = `/artifacts/${appId}/users/${newUser.uid}/profile/settings`;
                    const defaultProfile = {
                        greetingName: name,
                        totalBudget: 1500000,
                        currentSavings: 0,
                        targetSavings: 1000000,
                        savingsTargetName: "Dana Darurat",
                        pomodoroDuration: 25,
                    };
                    await setDoc(doc(db, profileDocPath), defaultProfile);
                } catch (error) {
                    console.error("Gagal mendaftar:", error);
                    showAlert('Gagal Mendaftar', `Terjadi kesalahan: ${error.code}`, true);
                }
            });

            forgotPasswordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('forgot-email').value;
                try {
                    await sendPasswordResetEmail(auth, email);
                    showAlert('Berhasil', 'Email reset password telah dikirim. Silakan cek inbox Anda.');
                    showAuthScreen('login-screen');
                } catch (error) {
                    console.error("Gagal reset password:", error);
                    showAlert('Gagal', `Terjadi kesalahan: ${error.code}`, true);
                }
            });


            logoutButton.addEventListener('click', () => {
                signOut(auth).catch(error => console.error("Gagal keluar:", error));
            });

            confirmationCancelBtn.addEventListener('click', () => {
                closeModal(confirmationModal);
                confirmationCallback = null;
            });
            confirmationConfirmBtn.addEventListener('click', () => {
                if (typeof confirmationCallback === 'function') {
                    confirmationCallback();
                }
                closeModal(confirmationModal);
                confirmationCallback = null;
            });

             closeButtons.forEach(button => {
                 button.addEventListener('click', () => {
                     const modalId = button.getAttribute('data-target-modal');
                     const modal = document.getElementById(modalId);
                     
                     if (modalId === 'view-comments-modal' && commentsUnsubscribe) {
                         commentsUnsubscribe();
                         commentsUnsubscribe = null;
                     }
                     closeModal(modal);
                 });
             });

            const swiper = new Swiper('.swiper-container', {
                on: { slideChange: function () { 
                    navItems.forEach((item) => {
                        item.classList.toggle('active', parseInt(item.dataset.index) === this.activeIndex);
                    });
                    const fabIsVisible = [1,2,3].includes(this.activeIndex);
                    fabButton.style.display = fabIsVisible ? 'flex' : 'none';
                    fabButton.style.transform = fabIsVisible ? 'scale(1)' : 'scale(0)';
                    if (this.activeIndex === 1) fabButton.innerHTML = `<i data-lucide="calendar-plus" style="width: 32px; height: 32px;"></i>`;
                    else if (this.activeIndex === 2) fabButton.innerHTML = `<i data-lucide="message-square-plus" style="width: 32px; height: 32px;"></i>`;
                    else if (this.activeIndex === 3) fabButton.innerHTML = `<i data-lucide="plus" style="width: 32px; height: 32px;"></i>`;
                    lucide.createIcons();
                }}
            });
            navItems.forEach(item => item.addEventListener('click', () => swiper.slideTo(parseInt(item.dataset.index))));

            fabButton.addEventListener('click', () => {
                if (swiper.activeIndex === 1) openModal(document.getElementById('add-schedule-modal'));
                else if (swiper.activeIndex === 2) openModal(createPostModal);
                else if (swiper.activeIndex === 3) openModal(addTaskModal);
            });


            document.getElementById('add-schedule-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newSchedule = {
                    day: currentDay,
                    title: document.getElementById('schedule-title').value,
                    location: document.getElementById('schedule-location').value,
                    startTime: document.getElementById('schedule-start-time').value,
                    endTime: document.getElementById('schedule-end-time').value,
                };
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'ascenda-app-test';
                    await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/schedules`), newSchedule);
                    document.getElementById('add-schedule-form').reset();
                    closeModal(document.getElementById('add-schedule-modal'));
                } catch (error) { console.error("Error adding schedule: ", error); }
            });

             scheduleContainer.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-schedule-btn');
                if (deleteBtn) {
                    const idToDelete = deleteBtn.dataset.id;
                    showConfirmationModal(
                        'Hapus Jadwal', 
                        'Yakin ingin menghapus jadwal ini?', 
                        async () => {
                            try {
                                const appId = typeof __app_id !== 'undefined' ? __app_id : 'ascenda-app-test';
                                const docRef = doc(db, `/artifacts/${appId}/users/${userId}/schedules`, idToDelete);
                                await deleteDoc(docRef);
                            } catch (error) { console.error("Error deleting schedule: ", error); }
                        }
                    );
                }
            });

            addTaskForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const task = {
                    title: document.getElementById('task-title').value,
                    course: document.getElementById('task-course').value,
                    deadline: document.getElementById('task-deadline').value,
                    priority: document.getElementById('task-priority').value,
                    completed: false,
                    createdAt: serverTimestamp()
                };
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'ascenda-app-test';
                    await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/tasks`), task);
                    addTaskForm.reset();
                    closeModal(addTaskModal);
                } catch(error) { console.error("Error adding task:", error); }
            });

            taskListContainer.addEventListener('click', (e) => {
                const checkbox = e.target.closest('.task-checkbox');
                const deleteBtn = e.target.closest('.delete-task-btn');
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'ascenda-app-test';

                if(checkbox) {
                    const taskId = checkbox.dataset.id;
                    const isCompleted = checkbox.checked;
                    try {
                        const taskRef = doc(db, `/artifacts/${appId}/users/${userId}/tasks`, taskId);
                        updateDoc(taskRef, { completed: isCompleted });
                    } catch (error) { console.error("Error updating task status:", error); }
                }

                if(deleteBtn) {
                    const taskId = deleteBtn.dataset.id;
                    showConfirmationModal(
                        'Hapus Tugas',
                        'Yakin ingin menghapus tugas ini?',
                        async () => {
                            try {
                                const taskRef = doc(db, `/artifacts/${appId}/users/${userId}/tasks`, taskId);
                                await deleteDoc(taskRef);
                            } catch (error) { console.error("Error deleting task:", error); }
                        }
                    );
                }
            });

            // --- Listener Komunitas ---
            document.getElementById('create-post-trigger').addEventListener('click', () => openModal(createPostModal));

            submitPostButton.addEventListener('click', async () => {
                const postInput = document.getElementById('post-input');
                const postText = postInput.value.trim();
                if (postText) {
                    submitPostButton.disabled = true;
                    submitPostButton.textContent = "Mengirim...";
                    const newPost = {
                        text: postText,
                        author: userProfile.greetingName || "Pengguna",
                        authorId: userId,
                        likes: 0,
                        commentsCount: 0,
                        likedBy: [],
                        createdAt: serverTimestamp()
                    };
                    try {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ascenda-app-test';
                        await addDoc(collection(db, `/artifacts/${appId}/public/data/posts`), newPost);
                        postInput.value = '';
                        closeModal(createPostModal);
                    } catch (error) { 
                        console.error("Error adding post:", error); 
                    } finally {
                        submitPostButton.disabled = false;
                        submitPostButton.textContent = "Kirim";
                    }
                }
            });

            feed.addEventListener('click', async (e) => {
                const deleteBtn = e.target.closest('.delete-post-btn');
                const likeBtn = e.target.closest('.like-button');
                const commentBtn = e.target.closest('.comment-button');
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'ascenda-app-test';

                if (deleteBtn) {
                    const postCard = deleteBtn.closest('.post-card');
                    const postId = postCard.dataset.postId;
                    showConfirmationModal(
                        'Hapus Postingan',
                        'Yakin ingin menghapus postingan ini?',
                        async () => {
                             try {
                                await deleteDoc(doc(db, `/artifacts/${appId}/public/data/posts`, postId));
                            } catch (error) { console.error('Error deleting post:', error); }
                        }
                    );
                }

                if (likeBtn) {
                    const postCard = likeBtn.closest('.post-card');
                    const postId = postCard.dataset.postId;
                    const postRef = doc(db, `/artifacts/${appId}/public/data/posts`, postId);
                    const postDoc = await getDoc(postRef);
                    if(postDoc.exists()){
                        const postData = postDoc.data();
                        const likedBy = postData.likedBy || [];
                        if(likedBy.includes(userId)){
                             await updateDoc(postRef, {
                                likes: increment(-1),
                                likedBy: likedBy.filter(id => id !== userId)
                            });
                        } else {
                            await updateDoc(postRef, {
                                likes: increment(1),
                                likedBy: [...likedBy, userId]
                            });
                        }
                    }
                }
                
                if (commentBtn) {
                    activePostIdForComment = commentBtn.closest('.post-card').dataset.postId;
                    renderComments(activePostIdForComment);
                    openModal(viewCommentsModal);
                }
            });

            addCommentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const commentInput = document.getElementById('comment-input');
                const text = commentInput.value.trim();
                const submitBtn = addCommentForm.querySelector('button[type="submit"]');

                if (text && activePostIdForComment) {
                    submitBtn.disabled = true; // Disable button
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'ascenda-app-test';
                    const postRef = doc(db, `/artifacts/${appId}/public/data/posts`, activePostIdForComment);
                    const commentsPath = `/artifacts/${appId}/public/data/posts/${activePostIdForComment}/comments`;
                    
                    const newComment = {
                        author: userProfile.greetingName || "Pengguna",
                        authorId: userId,
                        text: text,
                        createdAt: serverTimestamp()
                    };

                    try {
                        await addDoc(collection(db, commentsPath), newComment);
                        await updateDoc(postRef, { commentsCount: increment(1) });
                        commentInput.value = '';
                        closeModal(viewCommentsModal); // Close modal on success
                    } catch (error) {
                        console.error("Error adding comment:", error);
                    } finally {
                        submitBtn.disabled = false; // Re-enable button
                    }
                }
            });


            // --- Listener Profil & Keuangan ---
            addTransactionTrigger.addEventListener('click', () => openModal(addTransactionModal));
            financialReportTrigger.addEventListener('click', () => {
                const reportContent = document.getElementById('financial-report-content');
                reportContent.innerHTML = '';
                const expensesByCategory = allTransactions.reduce((acc, tx) => {
                    acc[tx.category] = (acc[tx.category] || 0) + tx.amount;
                    return acc;
                }, {});

                let totalExpenses = 0;
                let reportHTML = '';

                if (Object.keys(expensesByCategory).length === 0) {
                    reportHTML = '<p style="text-align:center; padding: 1rem 0;">Belum ada data transaksi bulan ini.</p>';
                } else {
                    for (const category in expensesByCategory) {
                        totalExpenses += expensesByCategory[category];
                        reportHTML += `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--bg-light);">
                                <span style="font-weight: 500;">${category}</span>
                                <strong>${formatCurrency(expensesByCategory[category])}</strong>
                            </div>
                        `;
                    }
                     reportHTML += `
                        <div style="display: flex; justify-content: space-between; margin-top: 1rem; font-size: 1.125rem;">
                            <strong>Total Pengeluaran</strong>
                            <strong>${formatCurrency(totalExpenses)}</strong>
                        </div>
                    `;
                }
                reportContent.innerHTML = reportHTML;
                openModal(financialReportModal);
            });

            addTransactionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const amount = parseInt(document.getElementById('transaction-amount').value);
                const category = document.getElementById('transaction-category').value;
                if (!isNaN(amount) && amount > 0) {
                     try {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ascenda-app-test';
                        await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/transactions`), {
                            amount,
                            category,
                            createdAt: serverTimestamp()
                        });
                        addTransactionForm.reset();
                        closeModal(addTransactionModal);
                    } catch (error) { console.error("Error adding transaction: ", error); }
                }
            });
            
            setBudgetTrigger.addEventListener('click', () => {
                document.getElementById('budget-amount').value = userProfile.totalBudget || 1500000;
                openModal(setBudgetModal);
            });
            
            setBudgetForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newTotalBudget = parseInt(document.getElementById('budget-amount').value);
                if (!isNaN(newTotalBudget) && newTotalBudget >= 0) {
                    try {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ascenda-app-test';
                        const profileDocPath = `/artifacts/${appId}/users/${userId}/profile/settings`;
                        await updateDoc(doc(db, profileDocPath), { totalBudget: newTotalBudget });
                        closeModal(setBudgetModal);
                    } catch (error) { console.error("Error setting budget: ", error); }
                }
            });


            editGreetingForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newName = document.getElementById('greeting-name-input').value.trim();
                if(newName) {
                     try {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ascenda-app-test';
                        const profileDocPath = `/artifacts/${appId}/users/${userId}/profile/settings`;
                        await updateDoc(doc(db, profileDocPath), { greetingName: newName });
                        closeModal(editGreetingModal);
                    } catch (error) { console.error("Error setting greeting name: ", error); }
                }
            });

            document.getElementById('edit-savings-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newName = document.getElementById('savings-target-name').value;
                const newTargetAmount = parseInt(document.getElementById('savings-target-amount').value);

                if (newName && !isNaN(newTargetAmount) && newTargetAmount > 0) {
                    try {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ascenda-app-test';
                        await updateDoc(doc(db, `/artifacts/${appId}/users/${userId}/profile/settings`), { 
                            savingsTargetName: newName,
                            targetSavings: newTargetAmount,
                            currentSavings: 0 // Reset tabungan saat target baru disimpan
                        });
                        closeModal(editSavingsModal);
                    } catch (error) { console.error("Error editing savings target:", error); }
                }
            });

            resetSavingsButton.addEventListener('click', () => {
                showConfirmationModal('Reset Tabungan', 'Anda yakin ingin mereset progres tabungan ini ke Rp0?', async () => {
                    try {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ascenda-app-test';
                        await updateDoc(doc(db, `/artifacts/${appId}/users/${userId}/profile/settings`), { currentSavings: 0 });
                        closeModal(editSavingsModal);
                    } catch (error) { console.error("Error resetting savings:", error); }
                });
            });

            document.getElementById('add-savings-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const amount = parseInt(document.getElementById('savings-amount').value);
                if (!isNaN(amount) && amount > 0) {
                    try {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ascenda-app-test';
                        const newCurrentSavings = (userProfile.currentSavings || 0) + amount;
                        await updateDoc(doc(db, `/artifacts/${appId}/users/${userId}/profile/settings`), { currentSavings: newCurrentSavings });
                        document.getElementById('add-savings-form').reset();
                        closeModal(addSavingsModal);
                    } catch (error) { console.error("Error adding savings:", error); }
                }
            });

            editGreetingTrigger.addEventListener('click', () => {
                document.getElementById('greeting-name-input').value = userProfile.greetingName || "";
                openModal(editGreetingModal);
            });

             editSavingsTrigger.addEventListener('click', () => {
                document.getElementById('savings-target-name').value = userProfile.savingsTargetName || "";
                document.getElementById('savings-target-amount').value = userProfile.targetSavings || 0;
                openModal(editSavingsModal);
            });

            savingsCardTrigger.addEventListener('click', (e) => {
                 if (e.target.id === 'start-new-target-button') return;
                 if (userProfile.currentSavings < userProfile.targetSavings) {
                    openModal(addSavingsModal);
                 }
            });

            // --- Listener Olahraga & Pomodoro ---
            pomodoroSettingsTrigger.addEventListener('click', () => {
                document.getElementById('pomodoro-duration').value = userProfile.pomodoroDuration || 25;
                openModal(pomodoroSettingsModal);
            });

            pomodoroSettingsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newDuration = parseInt(document.getElementById('pomodoro-duration').value);
                if (newDuration >= 1 && newDuration <= 120) {
                    try {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ascenda-app-test';
                        await updateDoc(doc(db, `/artifacts/${appId}/users/${userId}/profile/settings`), { pomodoroDuration: newDuration });
                        closeModal(pomodoroSettingsModal);
                    } catch (error) { console.error("Error updating pomodoro duration:", error); }
                }
            });

            const workoutListTrigger = document.getElementById('workout-list-trigger');
            const workoutListModal = document.getElementById('workout-list-modal');
            const workoutVideoModal = document.getElementById('workout-video-modal');
            workoutListTrigger.addEventListener('click', () => openModal(workoutListModal));
            document.getElementById('workout-list-content').addEventListener('click', (e) => {
                const card = e.target.closest('.workout-card');
                if (card) {
                    document.getElementById('workout-title').textContent = card.dataset.title;
                    closeModal(workoutListModal);
                    openModal(workoutVideoModal);
                }
            });
            
            // --- [NEW] Listener untuk toggle password ---
            const togglePassword = document.getElementById('toggle-password');
            const passwordInput = document.getElementById('password');
            togglePassword.addEventListener('click', function () {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                this.setAttribute('data-lucide', type === 'password' ? 'eye' : 'eye-off');
                lucide.createIcons();
            });

            const toggleSignupPassword = document.getElementById('toggle-signup-password');
            const signupPasswordInput = document.getElementById('signup-password');
            toggleSignupPassword.addEventListener('click', function () {
                const type = signupPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                signupPasswordInput.setAttribute('type', type);
                this.setAttribute('data-lucide', type === 'password' ? 'eye' : 'eye-off');
                lucide.createIcons();
            });


            // Panggilan setup awal
            applyTheme(localStorage.getItem('ascenda-theme') || 'dark');
        });
    </script>
</body>
</html>

